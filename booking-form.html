<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Đặt Phòng Chi Tiết - HUCE HOTEL</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px 15px;
    }
    .container {
      max-width: 1100px;
      margin: 0 auto;
      background: white;
      border-radius: 20px;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    header {
      background: linear-gradient(135deg, #1a4971, #0f3460);
      color: white;
      text-align: center;
      padding: 35px 20px;
    }
    header h1 { font-size: 38px; margin-bottom: 8px; }
    header p { opacity: 0.95; font-size: 18px; }

    .form-body { display: flex; flex-wrap: wrap; }
    .left, .right { flex: 1; min-width: 320px; padding: 40px; }
    .left { background: #f8f9fa; }
    .right { background: #fff; }

    h2 { color: #1a4971; margin-bottom: 25px; font-size: 26px; }
    label { display: block; margin: 18px 0 8px; font-weight: 600; color: #333; }
    input, select {
      width: 100%;
      padding: 14px;
      border: 2px solid #ddd;
      border-radius: 10px;
      font-size: 16px;
      transition: 0.3s;
    }
    input:focus, select:focus { border-color: #1a4971; outline: none; }

    #roomPreview {
      margin-top: 30px;
      padding: 30px;
      background: #f0f8ff;
      border-radius: 15px;
      text-align: center;
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
      display: none; /* Ẩn ban đầu */
    }
    #roomPreview img {
      width: 100%;
      max-height: 340px;
      object-fit: cover;
      border-radius: 12px;
      margin: 15px 0;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }
    #roomPreview h3 { color: #1a4971; font-size: 28px; margin: 15px 0; }
    #roomPreview .price { font-size: 34px; color: #e67e22; font-weight: bold; }

    .warning {
      background: #ffebee;
      color: #c62828;
      padding: 18px;
      border-radius: 12px;
      border-left: 6px solid #e74c3c;
      margin: 20px 0;
      font-weight: bold;
      font-size: 16px;
      text-align: center;
    }

    button {
      margin-top: 35px;
      width: 100%;
      padding: 18px;
      background: #27ae60;
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 20px;
      font-weight: bold;
      cursor: pointer;
      transition: 0.3s;
    }
    button:disabled {
      background: #95a5a6 !important;
      cursor: not-allowed;
      transform: none !important;
    }
    button:hover:not(:disabled) { background: #1e8449; transform: translateY(-3px); }

    /* TOAST SIÊU ĐẸP */
    .toast-success {
      position: fixed;
      bottom: 30px;
      left: 50%;
      transform: translateX(-50%);
      background: #27ae60;
      color: white;
      padding: 20px 50px;
      border-radius: 50px;
      font-size: 18px;
      font-weight: bold;
      box-shadow: 0 15px 35px rgba(0,0,0,0.3);
      z-index: 9999;
      opacity: 0;
      transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }
    .toast-success.show {
      opacity: 1;
      bottom: 60px;
    }

    @media (max-width: 768px) { .form-body { flex-direction: column; } }
  </style>
</head>
<body>

<!-- TOAST THÀNH CÔNG -->
<div id="successToast" class="toast-success">
  <span>Đặt phòng thành công! Chúng tôi sẽ liên hệ ngay.</span>
</div>

<div class="container">
  <header>
    <h1>HUCE HOTEL</h1>
    <p>Đặt phòng chi tiết – Dịch vụ 5 sao</p>
  </header>

  <div class="form-body">
    <div class="left">
      <h2>Thông tin đặt phòng</h2>

      <label>Họ và tên</label>
      <input type="text" id="fullName" placeholder="Sẽ tự động điền nếu đã đăng nhập">

      <label>Email</label>
      <input type="email" id="email" placeholder="abc@example.com">

      <label>Số điện thoại <span style="color:red">*</span></label>
      <input type="tel" id="phone" placeholder="0901234567" required>

      <label>Ngày đến <span style="color:red">*</span></label>
      <input type="date" id="checkin" required onchange="checkAvailability()">

      <label>Ngày đi <span style="color:red">*</span></label>
      <input type="date" id="checkout" required onchange="checkAvailability()">

      <label>Chọn phòng <span style="color:red">*</span></label>
      <select id="roomSelect" onchange="checkAvailability()" required>
        <option value="">-- Chọn số phòng --</option>
      </select>

      <button id="submitBtn" onclick="submitBooking()">XÁC NHẬN ĐẶT PHÒNG</button>
    </div>

    <div class="right">
      <h2>Xem trước phòng đã chọn</h2>
      <div id="roomPreview">
        <h3 id="roomTitle">Chưa chọn phòng</h3>
        <img id="roomImage" src="" alt="Ảnh phòng">
        <p id="roomDesc"></p>
        <div class="price" id="roomPrice">0đ / đêm</div>
        <div id="availabilityWarning"></div>
      </div>
    </div>
  </div>
</div>

<script>
// LẤY USER ĐÃ ĐĂNG NHẬP
const currentUser = JSON.parse(localStorage.getItem('user') || 'null');
if (currentUser) {
  document.getElementById("fullName").value = currentUser.name || '';
  document.getElementById("email").value = currentUser.email || '';
}

// DỮ LIỆU 30 PHÒNG – ĐỒNG BỘ VỚI main.js VÀ server.js
const rooms = [
  ...Array.from({length: 10}, (_, i) => ({ 
    id: 101 + i, type: "Phòng Đơn", price: 800000, image: "hotel1.jpg", 
    desc: `Phòng đơn hiện đại ${101+i}, view thành phố, đầy đủ tiện nghi.` 
  })),
  ...Array.from({length: 10}, (_, i) => ({ 
    id: 201 + i, type: "Phòng Đôi", price: 1200000, image: "hotel2.jpg", 
    desc: `Phòng đôi sang trọng ${201+i}, giường king size, ban công riêng.` 
  })),
  ...Array.from({length: 10}, (_, i) => ({ 
    id: 301 + i, type: "Phòng VIP Suite", price: 2800000, image: "hotel3.jpg", 
    desc: `Suite VIP ${301+i} – 80m², bồn jacuzzi, dịch vụ butler 24/7.` 
  }))
];

// Đổ phòng vào select
const select = document.getElementById("roomSelect");
rooms.forEach(room => {
  const opt = document.createElement("option");
  opt.value = room.id;
  opt.textContent = `Phòng ${room.id} - ${room.type} (${room.price.toLocaleString()}đ/đêm)`;
  select.appendChild(opt);
});

// TOAST ĐẸP
function showToast(message) {
  const toast = document.getElementById("successToast");
  toast.querySelector("span").textContent = message;
  toast.classList.add("show");
  setTimeout(() => toast.classList.remove("show"), 5000);
}

// KIỂM TRA TRÙNG PHÒNG + HIỆN ẢNH + CẢNH BÁO
async function checkAvailability() {
  const roomId = document.getElementById("roomSelect").value;
  const checkin = document.getElementById("checkin").value;
  const checkout = document.getElementById("checkout").value;
  const preview = document.getElementById("roomPreview");
  const warningDiv = document.getElementById("availabilityWarning");
  const submitBtn = document.getElementById("submitBtn");

  warningDiv.innerHTML = "";
  submitBtn.disabled = false;
  submitBtn.textContent = "XÁC NHẬN ĐẶT PHÒNG";

  if (!roomId) {
    preview.style.display = "none";
    return;
  }

  const room = rooms.find(r => r.id == roomId);

  // HIỆN ẢNH VÀ THÔNG TIN PHÒNG NGAY LẬP TỨC
  document.getElementById("roomTitle").textContent = `Phòng ${room.id} - ${room.type}`;
  document.getElementById("roomImage").src = `images/${room.image}`;
  document.getElementById("roomDesc").textContent = room.desc;
  document.getElementById("roomPrice").textContent = room.price.toLocaleString() + "đ / đêm";
  preview.style.display = "block";

  // KIỂM TRA TRÙNG NGÀY (nếu đã chọn đủ ngày)
  if (checkin && checkout) {
    try {
      const res = await fetch('/api/bookings/check', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ roomId: parseInt(roomId), checkin, checkout })
      });
      const data = await res.json();

      if (!data.available) {
        warningDiv.innerHTML = `
          <div class="warning">
            Phòng đã có khách đặt từ <strong>${data.conflict.from}</strong> đến <strong>${data.conflict.to}</strong><br>
            Khách hàng: <strong>${data.conflict.customer}</strong><br><br>
            Vui lòng chọn ngày khác hoặc phòng khác!
          </div>
        `;
        submitBtn.disabled = true;
        submitBtn.textContent = "PHÒNG ĐÃ ĐẶT – KHÔNG THỂ ĐẶT";
      }
    } catch (err) {
      console.error("Lỗi kiểm tra phòng:", err);
    }
  }
}

// ĐẶT PHÒNG – CHỈ TOAST ĐẸP
async function submitBooking() {
  const phone = document.getElementById("phone").value.trim();
  const checkin = document.getElementById("checkin").value;
  const checkout = document.getElementById("checkout").value;
  const roomId = document.getElementById("roomSelect").value;
  const name = document.getElementById("fullName").value.trim() || "Khách";

  if (!phone || !checkin || !checkout || !roomId) {
    alert("Vui lòng điền đầy đủ thông tin bắt buộc!");
    return;
  }

  const res = await fetch('/api/bookings', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      user: currentUser || null,
      roomId: parseInt(roomId),
      checkin, checkout,
      customerName: name,
      customerPhone: phone
    })
  });

  const data = await res.json();

  if (data.success) {
    showToast(`Đặt phòng thành công! Phòng ${roomId} từ ${checkin} → ${checkout}`);
    setTimeout(() => location.reload(), 3000);
  } else {
    alert("Lỗi: " + data.message);
  }
}
</script>

</body>
</html>